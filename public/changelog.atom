<?php
declare(strict_types=1);
/**
 * /changelog.atom (Atom 1.0)
 */
header('Content-Type: application/atom+xml; charset=utf-8');

$site   = 'https://www.klinflow.com';
$title  = 'KlinFlow Changelog';
$idBase = $site . '/changelog';

$path = __DIR__ . '/../assets/changelog.json';
$data = is_file($path) ? json_decode(file_get_contents($path) ?: '[]', true) : [];
$items = is_array($data) ? $data : [];

$updated = date('c', strtotime($items[0]['date'] ?? 'now'));

echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";
?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><?= htmlspecialchars($title, ENT_QUOTES) ?></title>
  <id><?= htmlspecialchars($idBase, ENT_QUOTES) ?></id>
  <updated><?= htmlspecialchars($updated, ENT_QUOTES) ?></updated>
  <link rel="alternate" href="<?= htmlspecialchars($site . '/changelog', ENT_QUOTES) ?>" />
  <link rel="self" type="application/atom+xml" href="<?= htmlspecialchars($site . '/changelog.atom', ENT_QUOTES) ?>" />
<?php foreach ($items as $i):
  $ver = (string)($i['version'] ?? 'vNext');
  $date= (string)($i['date'] ?? date('c'));
  $note= (string)($i['note'] ?? '');
  $url = $site . '/changelog#' . rawurlencode($ver);
  $upd = date('c', strtotime($date));
  $id  = $idBase . '/' . rawurlencode($ver);
?>
  <entry>
    <title><?= htmlspecialchars($ver, ENT_QUOTES) ?></title>
    <id><?= htmlspecialchars($id, ENT_QUOTES) ?></id>
    <updated><?= htmlspecialchars($upd, ENT_QUOTES) ?></updated>
    <link rel="alternate" href="<?= htmlspecialchars($url, ENT_QUOTES) ?>" />
    <content type="html"><![CDATA[<?= $note ?>]]></content>
  </entry>
<?php endforeach; ?>
</feed>